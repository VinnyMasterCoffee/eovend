<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Редактор инвентаризации</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: inline-block; width: 180px; font-weight: bold; }
        input { padding: 5px; border: 1px solid #000; }
        button { padding: 8px 20px; background: #4CAF50; color: white; border: none; cursor: pointer; }
    </style>
</head>
<body>
    <h2>Редактор инвентаризации кофе</h2>

    <!-- Поля для ввода данных -->
    <div class="form-group">
        <label>Дата инвентаризации:</label>
        <input type="date" id="inventoryDate" required>
    </div>
    
    <div class="form-group">
        <label>Номер маршрута (К):</label>
        <input type="text" id="routeNumber" required>
        
        <label style="width: 120px; margin-left: 20px;">Номер машины:</label>
        <input type="text" id="carNumber" required>
    </div>

    <!-- Загрузка шаблона -->
    <div class="form-group">
        <label>Загрузите шаблон Excel:</label>
        <input type="file" id="excelTemplate" accept=".xlsx,.xls">
    </div>

    <!-- Кнопка генерации -->
    <button onclick="generateReport()">Скачать отчёт</button>

    <script>
        // Названия месяцев для даты
        const monthNames = {
            nom: ["Январь", "Февраль", "Март", "Апрель", "Май", "Июнь", 
                  "Июль", "Август", "Сентябрь", "Октябрь", "Ноябрь", "Декабрь"],
            dat: ["января", "февраля", "марта", "апреля", "мая", "июня", 
                  "июля", "августа", "сентября", "октября", "ноября", "декабря"]
        };

        // Основная функция
        async function generateReport() {
            const fileInput = document.getElementById('excelTemplate');
            if (!fileInput.files.length) {
                alert('Сначала загрузите шаблон Excel!');
                return;
            }

            try {
                // 1. Читаем загруженный файл
                const file = fileInput.files[0];
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data);

                // 2. Обновляем данные
                updateWorkbook(workbook);

                // 3. Генерируем имя файла
                const date = new Date(document.getElementById('inventoryDate').value);
                const month = monthNames.nom[date.getMonth()];
                const year = date.getFullYear();
                const route = document.getElementById('routeNumber').value;
                const car = document.getElementById('carNumber').value;
                
                const fileName = `Инвентаризация ${month} ${year} Кофе К${route} ${car}.xlsx`;

                // 4. Скачиваем
                XLSX.writeFile(workbook, fileName);
                
            } catch (error) {
                alert(`Ошибка: ${error.message}`);
            }
        }

        // Обновление данных в шаблоне
        function updateWorkbook(workbook) {
            const date = new Date(document.getElementById('inventoryDate').value);
            const day = date.getDate();
            const month = monthNames.dat[date.getMonth()];
            const year = date.getFullYear();
            const route = document.getElementById('routeNumber').value;
            const car = document.getElementById('carNumber').value;

            // Обновляем каждый лист
            workbook.SheetNames.forEach(sheetName => {
                const ws = workbook.Sheets[sheetName];
                
                // 1. Дату (строка 3)
                ws['A3'].v = `"___${day}___" ${month} ${year} г.`;
                
                // 2. Номер машины (B22/C22)
                ws['B22'].v = `К${route}`;
                ws['C22'].v = car;
            });
        }

        // Устанавливаем текущую дату по умолчанию
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            document.getElementById('inventoryDate').value = today.toISOString().substr(0, 10);
        });
    </script>
</body>
</html>
