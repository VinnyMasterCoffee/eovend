<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Редактор инвентаризации кофе</title>
    <!-- Загружаем xlsx.js через CDN с проверкой -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: inline-block; width: 180px; font-weight: bold; }
        input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button { padding: 10px 20px; background: #4CAF50; color: white; border: none; cursor: pointer; }
        #status { margin: 15px 0; padding: 10px; border-radius: 4px; }
        .loading { background: #fff3cd; color: #856404; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h2>Редактор инвентаризации кофе</h2>
    
    <div id="status" class="loading">Загрузка библиотеки...</div>

    <!-- Форма остается без изменений -->
    <div class="form-group">
        <label>Дата инвентаризации:</label>
        <input type="date" id="inventoryDate" required>
    </div>
    
    <div class="form-group">
        <label>Номер маршрута (К):</label>
        <input type="text" id="routeNumber" required>
        <label style="margin-left: 20px;">Номер машины:</label>
        <input type="text" id="carNumber" required>
    </div>

    <h3>Фактические остатки:</h3>
    <div id="inventoryInputs"></div>

    <button id="downloadBtn" disabled>Скачать обновлённый файл</button>

    <script>
        // Ждем загрузки библиотеки XLSX
        function waitForXLSX(callback) {
            if (window.XLSX) {
                callback();
            } else {
                setTimeout(() => waitForXLSX(callback), 100);
            }
        }

        // Основной код запускается только после загрузки XLSX
        waitForXLSX(function() {
            document.getElementById('status').textContent = "Библиотека загружена. Загрузка шаблона...";
        // Конфигурация
        const TEMPLATE_PATH = '/eovend/templates/invent.xlsx'; // Исправленный путь к шаблону
        const monthNames = {
            nom: ["Январь", "Февраль", "Март", "Апрель", "Май", "Июнь", 
                  "Июль", "Август", "Сентябрь", "Октябрь", "Ноябрь", "Декабрь"],
            dat: ["января", "февраля", "марта", "апреля", "мая", "июня", 
                  "июля", "августа", "сентября", "октября", "ноября", "декабря"]
        };

        // Полный список товаров для редактирования (E6-E21 кроме исключений)
        const inventoryItems = [
            { id: 1, name: "Вода Нила Спрингс 19л" },
            { id: 2, name: "Горячий шоколад ARISTOCRAT ШВЕЙЦАРСКИЙ гранулы 500г" },
            { id: 3, name: "Какао ARISTOCRAT ШВЕЙЦАРСКИЙ 500г" },
            { id: 4, name: "Капучино ARISTOCRAT CLASSICO 500г" },
            { id: 5, name: "Капучино ARISTOCRAT VANILLA 500г" },
            { id: 6, name: "Капучино ARISTOCRAT CARAMEL 500г" },
            { id: 7, name: "Кофе молотый ARISTOCRAT COLUMBIA 500г" },
            { id: 8, name: "Кофе молотый ARISTOCRAT BRAZIL 500г" },
            { id: 9, name: "Кофе растворимый ARISTOCRAT GOLD 500г" },
            { id: 10, name: "Кофе растворимый ARISTOCRAT CLASSIC 500г" },
            { id: 11, name: "Латте ARISTOCRAT CLASSICO 500г" },
            { id: 12, name: "Латте ARISTOCRAT VANILLA 500г" },
            { id: 13, name: "Латте ARISTOCRAT CARAMEL 500г" },
            { id: 14, name: "Сахар-песок 1кг" },
            { id: 15, name: "Сливки сухие ARISTOCRAT 1кг" },
            { id: 16, name: "Смесь сухая ARISTOCRAT Клубника 1кг", editable: false }
        ].filter(item => item.editable !== false);

        let workbookTemplate = null;

        // Загрузка шаблона при старте
        async function loadTemplate() {
            try {
                const statusEl = document.getElementById('status');
                
                // 1. Загружаем шаблон
                statusEl.textContent = "Загрузка шаблона...";
                const response = await fetch(TEMPLATE_PATH);
                
                if (!response.ok) throw new Error(`Ошибка HTTP: ${response.status}`);
                
                const data = await response.arrayBuffer();
                workbookTemplate = XLSX.read(data);
                
                // 2. Проверяем структуру
                if (!workbookTemplate.SheetNames.includes('ведомость д-бух')) {
                    throw new Error("Шаблон не содержит лист 'ведомость д-бух'");
                }
                
                // 3. Создаем форму
                createInputForm();
                statusEl.textContent = "Шаблон успешно загружен!";
                statusEl.className = "success";
                document.getElementById('downloadBtn').disabled = false;
                
            } catch (error) {
                console.error("Ошибка загрузки шаблона:", error);
                const statusEl = document.getElementById('status');
                statusEl.textContent = `Ошибка загрузки шаблона: ${error.message}`;
                statusEl.className = "error";
                
                // Показываем дополнительные инструкции если файл не найден
                if (error.message.includes('404')) {
                    statusEl.innerHTML += `<br><br>Убедитесь, что файл шаблона находится по пути: ${TEMPLATE_PATH}`;
                }
            }
        }

        // Создание формы ввода
        function createInputForm() {
            const container = document.getElementById("inventoryInputs");
            container.innerHTML = ''; // Очищаем контейнер
            
            inventoryItems.forEach(item => {
                const div = document.createElement("div");
                div.className = "form-group";
                div.innerHTML = `
                    <label>${item.name}:</label>
                    <input type="number" id="item_${item.id}" min="0" value="0" step="1" class="inventory-item">
                `;
                container.appendChild(div);
            });
            
            // Установка текущей даты по умолчанию
            const today = new Date();
            document.getElementById('inventoryDate').valueAsDate = today;
        }

        // Генерация отчета
        document.getElementById('downloadBtn').addEventListener('click', function() {
            try {
                if (!validateForm()) return;
                
                // Показываем статус обработки
                const statusEl = document.getElementById('status');
                statusEl.textContent = "Подготовка файла...";
                statusEl.className = "loading";
                
                // Даем время на обновление UI
                setTimeout(() => {
                    try {
                        // Клонируем шаблон
                        const workbook = XLSX.read(XLSX.write(workbookTemplate, {type: 'array'}));
                        
                        // Обновляем данные
                        updateWorkbook(workbook);

                        // Генерируем имя файла
                        const date = new Date(document.getElementById('inventoryDate').value);
                        const month = monthNames.nom[date.getMonth()];
                        const year = date.getFullYear();
                        const route = document.getElementById('routeNumber').value.trim();
                        const car = document.getElementById('carNumber').value.trim();
                        
                        const fileName = `Инвентаризация ${month} ${year} Кофе К${route} ${car}.xlsx`;
                        
                        XLSX.writeFile(workbook, fileName);
                        
                        statusEl.textContent = "Файл успешно сгенерирован!";
                        statusEl.className = "success";
                    } catch (error) {
                        console.error("Ошибка генерации файла:", error);
                        statusEl.textContent = `Ошибка генерации файла: ${error.message}`;
                        statusEl.className = "error";
                    }
                }, 100);
                
            } catch (error) {
                console.error("Ошибка:", error);
                alert(`Ошибка: ${error.message}`);
            }
        });

        // Обновление данных в книге
        function updateWorkbook(wb) {
            const date = new Date(document.getElementById('inventoryDate').value);
            const day = date.getDate();
            const month = monthNames.dat[date.getMonth()];
            const year = date.getFullYear();
            const route = document.getElementById('routeNumber').value.trim();
            const car = document.getElementById('carNumber').value.trim();

            // Обновляем все листы
            wb.SheetNames.forEach(sheetName => {
                const ws = wb.Sheets[sheetName];
                
                // 1. Обновляем дату (A3)
                if (ws['A3']) {
                    ws['A3'].v = `"___${day}___" ${month} ${year} г.`;
                    ws['A3'].t = 's'; // Указываем что это строка
                }
                
                // 2. Обновляем остатки (E6-E21)
                inventoryItems.forEach(item => {
                    const cell = `E${5 + item.id}`;
                    const value = parseFloat(document.getElementById(`item_${item.id}`).value) || 0;
                    if (ws[cell]) {
                        ws[cell].v = value;
                        ws[cell].t = 'n'; // Указываем что это число
                    }
                });
                
                // 3. Обновляем номер машины (B22/C22)
                if (ws['B22']) {
                    ws['B22'].v = `К${route}`;
                    ws['B22'].t = 's';
                }
                if (ws['C22']) {
                    ws['C22'].v = car;
                    ws['C22'].t = 's';
                }
            });
        }

        // Валидация формы
        function validateForm() {
            let isValid = true;
            
            // Проверка основных полей
            const requiredFields = [
                {id: 'inventoryDate', message: 'Укажите дату инвентаризации'},
                {id: 'routeNumber', message: 'Укажите номер маршрута'},
                {id: 'carNumber', message: 'Укажите номер машины'}
            ];
            
            requiredFields.forEach(field => {
                const el = document.getElementById(field.id);
                if (!el.value || !el.value.trim()) {
                    el.classList.add('error-input');
                    alert(field.message);
                    isValid = false;
                } else {
                    el.classList.remove('error-input');
                }
            });
            
            // Проверка числовых полей
            document.querySelectorAll('.inventory-item').forEach(input => {
                const value = parseFloat(input.value);
                if (isNaN(value) || value < 0) {
                    input.classList.add('error-input');
                    isValid = false;
                } else {
                    input.classList.remove('error-input');
                }
            });
            
            if (!isValid) {
                alert("Проверьте правильность заполнения всех полей!");
                return false;
            }
            
            return true;
        }

        // Инициализация
       document.addEventListener('DOMContentLoaded', function() {
            loadTemplate();
        });
    </script>
</body>
</html>
